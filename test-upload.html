<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .upload-form { border: 2px dashed #ccc; padding: 40px; text-align: center; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        .message { margin: 20px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; margin: 20px 0; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ“¸ ä¸Šä¼ æµ‹è¯•é¡µé¢</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¸Šä¼ æµ‹è¯•é¡µé¢ï¼Œç”¨äºè°ƒè¯•ä¸Šä¼ é—®é¢˜ã€‚</p>
    
    <div class="upload-form">
        <input type="file" id="fileInput" accept="image/*">
        <br><br>
        <button class="btn" onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
    </div>
    
    <div id="message"></div>
    
    <h3>è°ƒè¯•æ—¥å¿—:</h3>
    <div id="log" class="log"></div>
    
    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${time}] ${message}`);
        }
        
        function showMessage(text, type = 'success') {
            const messageElement = document.getElementById('message');
            messageElement.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
        
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                log('é”™è¯¯: æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            log(`é€‰æ‹©çš„æ–‡ä»¶: ${file.name}`);
            log(`æ–‡ä»¶ç±»å‹: ${file.type}`);
            log(`æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                log('é”™è¯¯: ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 5 * 1024 * 1024) {
                showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                log('é”™è¯¯: æ–‡ä»¶å¤ªå¤§');
                return;
            }
            
            log('å¼€å§‹ä¸Šä¼ ...');
            
            const formData = new FormData();
            formData.append('photo', file);
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const progress = Math.round((e.loaded / e.total) * 100);
                    log(`ä¸Šä¼ è¿›åº¦: ${progress}%`);
                }
            };
            
            xhr.onload = function() {
                log(`HTTPçŠ¶æ€ç : ${xhr.status}`);
                log(`å“åº”å†…å®¹: ${xhr.responseText}`);
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            showMessage('ä¸Šä¼ æˆåŠŸï¼', 'success');
                            log('âœ… ä¸Šä¼ æˆåŠŸ');
                        } else {
                            showMessage('ä¸Šä¼ å¤±è´¥: ' + response.message, 'error');
                            log('âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + response.message);
                        }
                    } catch (error) {
                        showMessage('è§£æå“åº”å¤±è´¥', 'error');
                        log('âŒ JSONè§£æé”™è¯¯: ' + error.message);
                    }
                } else {
                    showMessage(`HTTPé”™è¯¯: ${xhr.status}`, 'error');
                    log(`âŒ HTTPé”™è¯¯: ${xhr.status} ${xhr.statusText}`);
                }
            };
            
            xhr.onerror = function() {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
                log('âŒ ç½‘ç»œé”™è¯¯');
            };
            
            xhr.ontimeout = function() {
                showMessage('ä¸Šä¼ è¶…æ—¶', 'error');
                log('âŒ ä¸Šä¼ è¶…æ—¶');
            };
            
            xhr.timeout = 30000; // 30ç§’è¶…æ—¶
            
            log('å‘é€POSTè¯·æ±‚åˆ° /upload');
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
        
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
